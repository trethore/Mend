# Mend

**Interactively apply messy diffs with confidence.**

Mend is a command-line tool designed to reliably apply diffs, especially those generated by Large Language Models (LLMs).

Where standard `patch` tools fail due to incorrect line numbers or slightly-off context, `mend` excels. It ignores line numbers and uses a powerful fuzzy-matching engine and an **interactive conflict resolution** system to ensure your changes land exactly where they should.

## Features

-   **Interactive Conflict Resolution:** Never get stuck on a failed patch again. If `mend` can't find a perfect spot or finds multiple possibilities, it prompts you to choose the correct location, skip the problematic hunk, or abort safely.

-   **Powerful Fuzzy Matching Engine:** A multi-stage algorithm that finds the correct patch location even with formatting changes, modified context lines, or other LLM-induced noise.
    -   **Level 0 (Strict):** An exact, line-by-line match.
    -   **Level 1 (Whitespace Insensitive):** Ignores leading/trailing whitespace and empty lines.
    -   **Level 2 (Anchor-Point Heuristic):** Uses the first and last lines of a change block as anchors to find the location, even if the content in between has been slightly modified.

-   **Full `git diff` Support:** Seamlessly handles file creations, deletions, and modifications within a single patch file. It even creates parent directories for new files automatically.

-   **Robust Parser:** Intelligently ignores conversational artifacts, malformed headers, and other junk that LLMs sometimes include in diff code blocks.

-   **Safe and Predictable:** Applies changes only after the entire patch is successfully resolved. Use the `--dry-run` flag to preview all intended changes without touching your files.

## Installation

Ensure you have the Rust toolchain installed. You can then install `mend` directly from the source code:

```bash
git clone https://your-git-repo-url/mend.git
cd mend
cargo install --path .
```

This will compile `mend` and make it available in your shell.

## Usage

### Applying a Patch

`mend` can auto-detect the target file from the diff header.

```bash
# Auto-detects the file from the diff and modifies it in-place
mend my_changes.diff
```

You can also specify the original file explicitly, though this is rarely needed:
```bash
mend path/to/original_file path/to/diff_file
```

### Piping from Stdin

`mend` can also read the diff from standard input, making it perfect for piping from other tools.

```bash
# Pipe a diff directly to mend
cat my_changes.diff | mend

# Generate a diff and apply it in one go
git diff | mend
```

### Previewing Changes (Dry Run)

To see which files will be modified, created, or deleted without writing any changes, use the `--dry-run` flag.

```bash
mend --dry-run my_changes.diff
```

### Interactive Mode in Action

If a patch hunk is ambiguous or cannot be applied, `mend` will prompt you for input.

**Ambiguous Match:**
```
[ERROR] Ambiguous match for hunk 1 in file src/main.rs. Possible locations:
  1. Line 42 (Score: 0.95)
  2. Line 118 (Score: 0.85)
Enter the index of the correct location, [s]kip this hunk, or [a]bort:
```

**Failed Match:**
```
[ERROR] Failed to apply hunk 2 for file src/main.rs. No matching context found.
Do you want to [s]kip this hunk or [a]bort the process? (s/a)
```

## Command-Line Reference

#### **Arguments:**

-   `mend [DIFF_FILE]`: The path to the diff/patch file. If omitted, `mend` reads from standard input.

#### **Flags:**

-   `--dry-run`: Preview all changes without writing to disk.
-   `--debug`: Enable highly detailed logs for debugging `mend` itself. Implies `--dry-run`.
-   `-v, --verbose`: Enable verbose logging to see which files and hunks are being processed.
-   `-f, --fuzziness <LEVEL>`: Manually set the matching strategy. Default: `2`.
    -   `0`: Strict mode only.
    -   `1`: Allows whitespace and empty line differences.
    -   `2`: Enables all strategies, including the anchor-point heuristic.
-   `--match-threshold <SCORE>`: Sets the minimum score (from `0.0` to `1.0`) required for a match when using the Level 2 heuristic. Default: `0.7`.

## How It Works

`mend` operates on a simple but powerful principle: **trust the content, not the coordinates.** It parses the context lines (` `) and removal lines (`-`) from a diff hunk and searches for that block of text in the original file, making it resilient to the incorrect line numbers that LLMs often produce.